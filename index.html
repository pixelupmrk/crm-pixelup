import React, { useEffect, useMemo, useState } from 'react'

/**
 * Colunas do funil: Novo â†’ Em Contato â†’ NegociaÃ§Ã£o â†’ Fechado
 * Drag & drop nativo (HTML5) para evitar libs extras e facilitar abrir no CodeSandbox.
 * PersistÃªncia simples via localStorage.
 */

const COLUMNS = [
  { key: 'novo',        title: 'Novo' },
  { key: 'contato',     title: 'Em Contato' },
  { key: 'negociacao',  title: 'NegociaÃ§Ã£o' },
  { key: 'fechado',     title: 'Fechado' },
]

const SEED = [
  { id: 'L-101', nome: 'Maria Silva',  tel: '+55 47 99999-1111', col: 'novo' },
  { id: 'L-102', nome: 'JoÃ£o Santos',  tel: '+55 47 98888-2222', col: 'contato' },
  { id: 'L-103', nome: 'Carla Souza',  tel: '+55 47 97777-3333', col: 'negociacao' },
  { id: 'L-104', nome: 'Edu Lima',     tel: '+55 47 96666-4444', col: 'novo' },
]

const LS_KEY = 'pixelup-crm-leads'

function LeadCard({ lead, onDragStart }) {
  return (
    <div
      draggable
      onDragStart={(e) => onDragStart(e, lead)}
      className='rounded-xl border border-zinc-800 bg-zinc-900 p-3 text-sm cursor-grab active:cursor-grabbing hover:border-blue-500 hover:bg-zinc-900/80 transition'
    >
      <div className='font-medium'>{lead.nome}</div>
      <div className='text-xs text-white/60'>{lead.tel}</div>
      <div className='mt-2 text-[10px] uppercase tracking-wide text-white/40'>{lead.id}</div>
    </div>
  )
}

function Column({ title, columnKey, items, onDropLead }) {
  const [isOver, setIsOver] = useState(false)

  function onDragOver(e) {
    e.preventDefault()
    setIsOver(true)
  }
  function onDragLeave() {
    setIsOver(false)
  }
  function onDrop(e) {
    e.preventDefault()
    setIsOver(false)
    const data = e.dataTransfer.getData('application/x-lead')
    if (!data) return
    const payload = JSON.parse(data)
    onDropLead(payload.id, columnKey)
  }

  return (
    <div
      onDragOver={onDragOver}
      onDragLeave={onDragLeave}
      onDrop={onDrop}
      className={`flex-1 min-w-[240px] rounded-2xl border p-3 bg-zinc-950 transition
        ${isOver ? 'border-blue-500 bg-zinc-900' : 'border-zinc-800'}`}
    >
      <div className='flex items-center justify-between mb-3'>
        <h3 className='text-blue-400 font-semibold'>{title}</h3>
        <span className='text-xs text-white/60'>{items.length}</span>
      </div>
      <div className='space-y-2'>
        {items.map((lead) => (
          <LeadCard
            key={lead.id}
            lead={lead}
            onDragStart={(e, l) => {
              e.dataTransfer.setData('application/x-lead', JSON.stringify({ id: l.id }))
              // efeito visual ao arrastar
              e.dataTransfer.effectAllowed = 'move'
            }}
          />
        ))}
        {items.length === 0 && (
          <div className='text-xs text-white/40 italic'>Arraste leads para cÃ¡â€¦</div>
        )}
      </div>
    </div>
  )
}

export default function Leads(){
  const [leads, setLeads] = useState(() => {
    try {
      const stored = localStorage.getItem(LS_KEY)
      return stored ? JSON.parse(stored) : SEED
    } catch {
      return SEED
    }
  })

  useEffect(() => {
    localStorage.setItem(LS_KEY, JSON.stringify(leads))
  }, [leads])

  const grouped = useMemo(() => {
    const g = { novo: [], contato: [], negociacao: [], fechado: [] }
    for (const l of leads) g[l.col]?.push(l)
    return g
  }, [leads])

  function moveLead(leadId, toCol) {
    setLeads((prev) =>
      prev.map((l) => (l.id === leadId ? { ...l, col: toCol } : l))
    )
  }

  function addLead() {
    const nome = prompt('Nome do lead:')
    if (!nome) return
    const tel = prompt('Telefone (WhatsApp):') || ''
    const id = 'L-' + Math.random().toString(36).slice(2, 7).toUpperCase()
    setLeads((prev) => [{ id, nome, tel, col: 'novo' }, ...prev])
  }

  function resetLeads() {
    if (confirm('Restaurar leads de exemplo?')) {
      setLeads(SEED)
    }
  }

  return (
    <div className='space-y-4'>
      {/* Header */}
      <div className='flex items-center justify-between'>
        <h2 className='text-2xl font-semibold text-blue-500'>ðŸ‘¥ Leads & Funil (Kanban)</h2>
        <div className='flex gap-2'>
          <button
            onClick={addLead}
            className='bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-xl text-sm'
          >
            + Novo Lead
          </button>
          <button
            onClick={resetLeads}
            className='bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-xl text-sm border border-zinc-700'
          >
            Restaurar
          </button>
        </div>
      </div>

      {/* Board */}
      <div className='grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3'>
        {COLUMNS.map((c) => (
          <Column
            key={c.key}
            title={c.title}
            columnKey={c.key}
            items={grouped[c.key]}
            onDropLead={moveLead}
          />
        ))}
      </div>

      {/* Dicas */}
      <div className='text-xs text-white/50'>
        Dica: arraste os cartÃµes entre as colunas para mudar o status do lead.
      </div>
    </div>
  )
}
<h1>ðŸš€ CRM PixelUp â€” v2</h1>
<p>Deploy automÃ¡tico funcionando pela Vercel! ðŸŽ‰</p>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM PixelUp</title>
</head>
<body style="font-family: Arial, sans-serif; text-align:center; margin-top: 50px;">
  <h1>ðŸš€ CRM PixelUp</h1>
  <p>ParabÃ©ns! Seu primeiro deploy na Vercel estÃ¡ funcionando.</p>
</body>
</html>
