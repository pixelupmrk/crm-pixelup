<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRM PixelUp — Lista + Kanban</title>
  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:
        linear-gradient(rgba(8,12,18,.82), rgba(8,12,18,.82)),
        url('pixelup-bg.jpg') center/cover fixed no-repeat;
      color:#eaf6ff;
    }
    .topbar{
      position:sticky;top:0;z-index:10;
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 20px;background:rgba(11,21,32,.75);
      border-bottom:1px solid #102437;backdrop-filter:blur(4px);
    }
    .topbar h1{margin:0;font-size:20px;font-weight:700}
    .topbar h1 span{color:#2bb8ff;text-shadow:0 0 14px rgba(43,184,255,.65)}

    .container{max-width:1200px;margin:24px auto;padding:0 16px;display:grid;gap:18px}
    .card{
      background:rgba(13,27,41,.85);backdrop-filter:blur(2px);
      border:1px solid #102437;border-radius:14px;padding:16px;box-shadow:0 8px 40px rgba(0,0,0,.25);
    }
    h2{margin:0 0 12px;font-size:18px}

    .form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .form-grid textarea{grid-column:1/-1;min-height:80px}
    .form-grid button{grid-column:1/-1}
    input,select,textarea{background:#0f2132;border:1px solid #17324a;border-radius:10px;padding:10px 12px;color:#d9f1ff;outline:none}
    input::placeholder,textarea::placeholder{color:#7fa8c3}
    .btn{background:#18a4ff;border:1px solid #18a4ff;color:#001727;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border-color:#17324a;color:#cde9ff}

    .list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px;flex-wrap:wrap}
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .filter-dates{display:flex;gap:8px;align-items:center}

    .table-wrap{overflow-x:auto;border:1px solid #102437;border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th{padding:10px;border-bottom:1px solid #102437;text-align:left;font-size:14px;white-space:nowrap;background:#0b1520;position:sticky;top:0}
    td{padding:10px;border-bottom:1px solid #102437;text-align:left;font-size:14px;white-space:normal;word-break:break-word}
    tr:hover{background:#0f1d2b}
    tr.clickable{cursor:pointer}
    .actions-cell button{background:transparent;border:1px solid #17324a;color:#9fd9ff;padding:6px 10px;border-radius:8px;margin-right:6px;cursor:pointer}
    /* links rápidos */
    a.quick{color:#9fd9ff;text-decoration:underline}
    a.quick:hover{text-decoration:none;opacity:.9}

    /* === KANBAN === */
    .view-switch{display:flex;gap:8px;align-items:center;margin:0 0 8px}
    .view-switch .tab{background:#0f2132;border:1px solid #17324a;color:#cde9ff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .view-switch .tab.active{background:#18a4ff;border-color:#18a4ff;color:#001727;font-weight:700}

    .kanban{display:none;gap:12px;align-items:flex-start}
    .kanban.visible{display:grid;grid-template-columns:repeat(5,1fr)}
    .kcol{
      background:rgba(13,27,41,.9);border:1px solid #102437;border-radius:12px;
      min-height:300px;max-height:70vh;display:flex;flex-direction:column;
    }
    .khead{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #102437}
    .khead .title{font-weight:700}
    .khead .count{background:#0f2132;border:1px solid #17324a;border-radius:999px;padding:2px 8px;font-size:12px}
    .kbody{padding:10px;overflow:auto;flex:1;display:flex;flex-direction:column;gap:8px}
    .kcard{background:#0f2132;border:1px solid #17324a;border-radius:10px;padding:10px;cursor:grab}
    .kcard:active{cursor:grabbing}
    .kdrop{outline:2px dashed #18a4ff;outline-offset:-6px}

    /* Cores por coluna */
    .kcol[data-stage="novo"]      {border-color:#3b82f6;}
    .kcol[data-stage="qualificado"]{border-color:#a855f7;}
    .kcol[data-stage="proposta"]  {border-color:#f59e0b;}
    .kcol[data-stage="vendido"]   {border-color:#22c55e;}
    .kcol[data-stage="perdido"]   {border-color:#ef4444;}
    .kcol[data-stage] .khead .count{color:#9fd9ff}
    .kcol[data-stage="novo"] .khead .title{color:#60a5fa}
    .kcol[data-stage="qualificado"] .khead .title{color:#c084fc}
    .kcol[data-stage="proposta"] .khead .title{color:#fbbf24}
    .kcol[data-stage="vendido"] .khead .title{color:#34d399}
    .kcol[data-stage="perdido"] .khead .title{color:#f87171}

    @media (max-width:1000px){.kanban.visible{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:600px){.kanban.visible{grid-template-columns:1fr}}

    /* === MODAL DETALHES / EDIÇÃO === */
    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px;
    }
    .modal-content{
      background:#0f2132;color:#eaf6ff;border:1px solid #17324a;border-radius:14px;
      width:100%;max-width:560px;padding:18px;box-shadow:0 10px 40px rgba(0,0,0,.5);
    }
    .modal-header{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .modal-header h3{margin:0;font-size:18px}
    .modal-actions{display:flex;gap:8px}
    .modal-close{background:transparent;border:1px solid #17324a;color:#cde9ff;border-radius:10px;padding:6px 10px;cursor:pointer}
    .dl{display:grid;grid-template-columns:120px 1fr;gap:8px;margin-top:8px}
    .dl b{color:#9fd9ff}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; opacity:.9}
    .edit-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .edit-grid textarea{grid-column:1/-1;min-height:100px}
  </style>
</head>
<body>
  <header class="topbar"><h1>CRM <span>PixelUp</span></h1></header>

  <main class="container">
    <!-- Form -->
    <section class="card">
      <h2>Novo Lead</h2>
      <form id="leadForm" class="form-grid">
        <input id="name" placeholder="Nome" required />
        <input id="email" type="email" placeholder="E-mail" />
        <input id="phone" placeholder="WhatsApp" />
        <select id="stage">
          <option value="novo">Novo</option>
          <option value="qualificado">Qualificado</option>
          <option value="proposta">Proposta</option>
          <option value="vendido">Vendido</option>
          <option value="perdido">Perdido</option>
        </select>
        <input id="owner" placeholder="Atendente (quem atende)" />
        <input id="source" placeholder="Origem" />
        <input id="date" type="date" />
        <textarea id="notes" placeholder="Notas"></textarea>
        <button class="btn" type="submit">Salvar</button>
      </form>
    </section>

    <!-- Lista + Kanban -->
    <section class="card">
      <div class="list-header">
        <h2>Leads</h2>
        <div class="filters">
          <input id="search" placeholder="Buscar..." />
          <select id="filterOwner">
            <option value="">Todos atendentes</option>
          </select>
          <div class="filter-dates">
            <span>De</span><input id="filterStart" type="date">
            <span>Até</span><input id="filterEnd" type="date">
          </div>
          <button id="exportCsv" class="btn">Exportar CSV</button>
        </div>
      </div>

      <div class="view-switch">
        <button id="tabList" class="tab active">Lista</button>
        <button id="tabKanban" class="tab">Kanban</button>
      </div>

      <!-- LISTA -->
      <div class="table-wrap" id="tableWrap">
        <table id="leadsTable">
          <thead>
            <tr>
              <th>Nome</th><th>E-mail</th><th>WhatsApp</th><th>Atendente</th><th>Estágio</th><th>Origem</th><th>Data</th><th>Atualizado</th><th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- KANBAN -->
      <div id="kanban" class="kanban">
        <div class="kcol" data-stage="novo">
          <div class="khead"><span class="title">Novo</span><span class="count" id="count-novo">0</span></div>
          <div class="kbody" id="col-novo"></div>
        </div>
        <div class="kcol" data-stage="qualificado">
          <div class="khead"><span class="title">Qualificado</span><span class="count" id="count-qualificado">0</span></div>
          <div class="kbody" id="col-qualificado"></div>
        </div>
        <div class="kcol" data-stage="proposta">
          <div class="khead"><span class="title">Proposta</span><span class="count" id="count-proposta">0</span></div>
          <div class="kbody" id="col-proposta"></div>
        </div>
        <div class="kcol" data-stage="vendido">
          <div class="khead"><span class="title">Vendido</span><span class="count" id="count-vendido">0</span></div>
          <div class="kbody" id="col-vendido"></div>
        </div>
        <div class="kcol" data-stage="perdido">
          <div class="khead"><span class="title">Perdido</span><span class="count" id="count-perdido">0</span></div>
          <div class="kbody" id="col-perdido"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
  document.addEventListener("DOMContentLoaded", function(){
    const LS_KEY="pixelup_crm_leads_v1";
    let leads=[]; try{ leads=JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch(e){ leads=[]; }
    const persist=()=>localStorage.setItem(LS_KEY, JSON.stringify(leads));

    const form=document.getElementById("leadForm");
    const tbody=document.querySelector("#leadsTable tbody");
    const search=document.getElementById("search");
    const fOwner=document.getElementById("filterOwner");
    const fStart=document.getElementById("filterStart");
    const fEnd=document.getElementById("filterEnd");
    const exportBtn=document.getElementById("exportCsv");
    const tabList=document.getElementById("tabList");
    const tabKanban=document.getElementById("tabKanban");
    const tableWrap=document.getElementById("tableWrap");
    const kanbanEl=document.getElementById("kanban");

    const esc = s => String(s||"").replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;"," >":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const digits = s => (String(s||"").replace(/\D/g,''));
    function parseDateTs(str,end){if(!str)return null;let y,m,d;if(str.includes("-")){const p=str.split("-");y=+p[0];m=+p[1]-1;d=+p[2];}else if(str.includes("/")){const p=str.split("/");d=+p[0];m=+p[1]-1;y=+p[2];}else return null;return new Date(y,m,d,end?23:0,end?59:0,end?59:0,end?999:0).getTime();}

    /* ===== MODAL ===== */
    function showLeadDetails(lead){
      const wa = digits(lead.phone||"");
      const waLink = wa ? `<a class="quick" href="https://wa.me/${wa}" target="_blank" rel="noopener">Abrir no WhatsApp</a>` : '-';
      const mail = lead.email ? `<a class="quick" href="mailto:${encodeURIComponent(lead.email)}">Enviar e-mail</a>` : '-';

      const modal=document.createElement("div");
      modal.className="modal";
      modal.innerHTML=`
        <div class="modal-content" role="dialog" aria-modal="true">
          <div class="modal-header">
            <h3>Detalhes do Lead</h3>
            <div class="modal-actions">
              <button class="btn ghost" id="editBtn">Editar</button>
              <button class="modal-close" id="closeModalBtn">Fechar</button>
            </div>
          </div>
          <div id="detailsView" class="dl">
            <b>Nome</b> <div>${esc(lead.name)}</div>
            <b>E-mail</b> <div>${esc(lead.email||"")} &nbsp; ${mail}</div>
            <b>WhatsApp</b> <div class="mono">${esc(lead.phone||"")} &nbsp; ${waLink}</div>
            <b>Atendente</b> <div>${esc(lead.owner||"")}</div>
            <b>Estágio</b> <div>${esc(lead.stage)}</div>
            <b>Origem</b> <div>${esc(lead.source||"")}</div>
            <b>Data</b> <div>${esc(lead.date||"")}</div>
            <b>Criado</b> <div>${new Date(lead.createdAt).toLocaleString()}</div>
            <b>Atualizado</b> <div>${new Date(lead.updatedAt).toLocaleString()}</div>
            <b>Notas</b> <div style="white-space:pre-wrap">${esc(lead.notes||"-")}</div>
          </div>

          <form id="editForm" class="edit-grid" style="display:none;margin-top:8px">
            <input  id="e_name"  placeholder="Nome" />
            <input  id="e_email" placeholder="E-mail" />
            <input  id="e_phone" placeholder="WhatsApp" />
            <input  id="e_owner" placeholder="Atendente" />
            <select id="e_stage">
              <option value="novo">Novo</option>
              <option value="qualificado">Qualificado</option>
              <option value="proposta">Proposta</option>
              <option value="vendido">Vendido</option>
              <option value="perdido">Perdido</option>
            </select>
            <input  id="e_source" placeholder="Origem" />
            <input  id="e_date"   type="date" />
            <textarea id="e_notes" placeholder="Notas"></textarea>
            <div style="grid-column:1/-1;display:flex;gap:8px;justify-content:flex-end">
              <button type="button" class="btn ghost" id="cancelEdit">Cancelar</button>
              <button type="submit" class="btn">Salvar alterações</button>
            </div>
          </form>
        </div>`;

      const close = () => modal.remove();
      modal.addEventListener("click", e=>{ if(e.target===modal) close(); });
      modal.querySelector("#closeModalBtn").addEventListener("click", close);
      document.addEventListener("keydown", function escKey(ev){ if(ev.key==="Escape"){ close(); document.removeEventListener("keydown", escKey);} });

      const details = modal.querySelector("#detailsView");
      const formE = modal.querySelector("#editForm");
      const editBtn = modal.querySelector("#editBtn");
      const fillEdit = () => {
        modal.querySelector("#e_name").value  = lead.name||"";
        modal.querySelector("#e_email").value = lead.email||"";
        modal.querySelector("#e_phone").value = lead.phone||"";
        modal.querySelector("#e_owner").value = lead.owner||"";
        modal.querySelector("#e_stage").value = lead.stage||"novo";
        modal.querySelector("#e_source").value= lead.source||"";
        modal.querySelector("#e_date").value  = lead.date||"";
        modal.querySelector("#e_notes").value = lead.notes||"";
      };
      editBtn.addEventListener("click", ()=>{
        fillEdit();
        details.style.display="none";
        formE.style.display="grid";
      });
      modal.querySelector("#cancelEdit").addEventListener("click", ()=>{
        formE.reset();
        formE.style.display="none";
        details.style.display="grid";
      });
      formE.addEventListener("submit",(ev)=>{
        ev.preventDefault();
        lead.name   = modal.querySelector("#e_name").value.trim();
        lead.email  = modal.querySelector("#e_email").value.trim();
        lead.phone  = modal.querySelector("#e_phone").value.trim();
        lead.owner  = modal.querySelector("#e_owner").value.trim();
        lead.stage  = modal.querySelector("#e_stage").value;
        lead.source = modal.querySelector("#e_source").value.trim();
        lead.date   = modal.querySelector("#e_date").value;
        lead.notes  = modal.querySelector("#e_notes").value.trim();
        lead.updatedAt = Date.now();
        persist();
        close();
        renderAll();
      });

      document.body.appendChild(modal);
    }

    /* ===== LISTA ===== */
    function renderList(){
      tbody.innerHTML="";
      const q=(search?.value||"").toLowerCase();
      const ownerFilter=fOwner?.value||"";
      const sTs=parseDateTs(fStart?.value); const eTs=parseDateTs(fEnd?.value,true);

      const filtered = leads.filter(l=>{
        const txt=((l.name||"")+" "+(l.email||"")+" "+(l.phone||"")+" "+(l.owner||"")+" "+(l.source||"")+" "+(l.notes||"")).toLowerCase();
        const d=l.date?parseDateTs(l.date):l.updatedAt;
        if(q && !txt.includes(q)) return false;
        if(ownerFilter && (l.owner||"")!==ownerFilter) return false;
        if(sTs && d<sTs) return false;
        if(eTs && d>eTs) return false;
        return true;
      });

      for(const l of filtered){
        const tr=document.createElement("tr");
        tr.className="clickable";
        tr.dataset.id=l.id;

        const mailCell = l.email ? `<a class="quick" href="mailto:${encodeURIComponent(l.email)}" onclick="event.stopPropagation()">${esc(l.email)}</a>` : "";
        const waDigits = digits(l.phone||"");
        const waCell = waDigits ? `<a class="quick" href="https://wa.me/${waDigits}" target="_blank" rel="noopener" onclick="event.stopPropagation()">${esc(l.phone)}</a>` : esc(l.phone||"");

        tr.innerHTML=`<td>${esc(l.name)}</td>
                      <td>${mailCell}</td>
                      <td>${waCell}</td>
                      <td>${esc(l.owner||"")}</td>
                      <td>${esc(l.stage)}</td>
                      <td>${esc(l.source||"")}</td>
                      <td>${esc(l.date||"")}</td>
                      <td>${new Date(l.updatedAt).toLocaleString()}</td>`;
        const td=document.createElement("td"); td.className="actions-cell";
        const del=document.createElement("button"); del.textContent="Excluir";
        del.addEventListener("click", (ev)=>{ ev.stopPropagation(); leads=leads.filter(x=>x.id!==l.id);persist();renderAll(); });
        td.appendChild(del); tr.appendChild(td);
        tbody.appendChild(tr);
      }

      // Atualiza dropdown de atendentes
      populateOwnerFilter();
    }

    /* clique na linha da LISTA abre modal */
    tbody.addEventListener("click", (e)=>{
      if(e.target.closest(".actions-cell")) return;
      const tr=e.target.closest("tr");
      if(!tr) return;
      const lead=leads.find(x=>x.id===tr.dataset.id);
      if(lead) showLeadDetails(lead);
    });

    function populateOwnerFilter(){
      if(!fOwner) return;
      const selected = fOwner.value;
      const owners=[...new Set(leads.map(l=>l.owner).filter(Boolean))].sort();
      const options = ['<option value="">Todos atendentes</option>', ...owners.map(o=>`<option ${o===selected?'selected':''} value="${esc(o)}">${esc(o)}</option>`)];
      fOwner.innerHTML = options.join('');
    }

    fOwner.addEventListener("change", renderList);

    /* ===== KANBAN ===== */
    const STAGES=["novo","qualificado","proposta","vendido","perdido"];

    function renderKanban(){
      for(const stage of STAGES){
        const body=document.getElementById("col-"+stage);
        const count=document.getElementById("count-"+stage);
        body.innerHTML="";
        const items=leads.filter(x=>(x.stage||"novo")===stage);
        count.textContent=items.length;
        for(const l of items){
          const card=document.createElement("div");
          card.className="kcard"; card.draggable=true; card.dataset.id=l.id;
          const owner = l.owner ? `<div class="meta">Atendente: ${esc(l.owner)}</div>` : "";
          card.innerHTML=`<div class="name">${esc(l.name||"")}</div>
                          <div class="meta">${esc(l.email||"")}</div>${owner}`;
          card.addEventListener("click", ()=> showLeadDetails(l));
          body.appendChild(card);
        }
      }
      bindDnD();
    }

    function bindDnD(){
      document.querySelectorAll(".kcard").forEach(card=>{
        card.addEventListener("dragstart", e=>{ e.dataTransfer.setData("text/plain", card.dataset.id); });
      });
      document.querySelectorAll(".kbody").forEach(col=>{
        col.addEventListener("dragover", e=>{ e.preventDefault(); col.classList.add("kdrop"); });
        col.addEventListener("dragleave", ()=>col.classList.remove("kdrop"));
        col.addEventListener("drop", e=>{
          e.preventDefault(); col.classList.remove("kdrop");
          const id=e.dataTransfer.getData("text/plain");
          const l=leads.find(x=>x.id===id);
          if(l){ l.stage=col.parentElement.dataset.stage; l.updatedAt=Date.now(); persist(); renderAll(); }
        });
      });
    }

    function renderAll(){renderList();renderKanban();}

    /* ===== EXPORTAR CSV ===== */
    function toCsvRow(arr){return arr.map(v=>{
      const s = (v==null?"":String(v)).replace(/"/g,'""');
      return `"${s}"`;
    }).join(",");}
    function downloadCsv(filename, csv){
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }
    exportBtn.addEventListener("click", ()=>{
      const headers = ["id","nome","email","whatsapp","atendente","estagio","origem","data","notas","criado_em","atualizado_em"];
      const rows = [headers];
      const ownerFilter=fOwner?.value||"";
      const q=(search?.value||"").toLowerCase();
      const sTs=parseDateTs(fStart?.value); const eTs=parseDateTs(fEnd?.value,true);

      const filtered = leads.filter(l=>{
        const txt=((l.name||"")+" "+(l.email||"")+" "+(l.phone||"")+" "+(l.owner||"")+" "+(l.source||"")+" "+(l.notes||"")).toLowerCase();
        const d=l.date?parseDateTs(l.date):l.updatedAt;
        if(q && !txt.includes(q)) return false;
        if(ownerFilter && (l.owner||"")!==ownerFilter) return false;
        if(sTs && d<sTs) return false;
        if(eTs && d>eTs) return false;
        return true;
      });

      for(const l of filtered){
        rows.push([
          l.id, l.name||"", l.email||"", l.phone||"", l.owner||"",
          l.stage||"", l.source||"", l.date||"", l.notes||"",
          new Date(l.createdAt).toISOString(), new Date(l.updatedAt).toISOString()
        ]);
      }
      const csv = rows.map(toCsvRow).join("\n");
      downloadCsv(`leads_pixelup_${new Date().toISOString().slice(0,10)}.csv`, csv);
    });

    /* ===== FORM ===== */
    if(form){
      form.addEventListener("submit", e=>{
        e.preventDefault();
        const lead={id:String(Date.now()),
          name:document.getElementById("name").value.trim(),
          email:document.getElementById("email").value.trim(),
          phone:document.getElementById("phone").value.trim(),
          stage:document.getElementById("stage").value,
          owner:document.getElementById("owner").value.trim(),
          source:document.getElementById("source").value.trim(),
          date:document.getElementById("date").value,
          notes:document.getElementById("notes").value.trim(),
          createdAt:Date.now(),updatedAt:Date.now()};
        if(!lead.name){alert("Informe o nome");return;}
        leads.push(lead);persist();form.reset();renderAll();
      });
    }

    /* ===== ABAS ===== */
    if(tabList&&tabKanban&&tableWrap&&kanbanEl){
      tabList.onclick=()=>{tabList.classList.add("active");tabKanban.classList.remove("active");tableWrap.style.display="block";kanbanEl.classList.remove("visible");};
      tabKanban.onclick=()=>{tabKanban.classList.add("active");tabList.classList.remove("active");tableWrap.style.display="none";kanbanEl.classList.add("visible");renderKanban();};
    }

    [search,fOwner,fStart,fEnd].forEach(el=>el&&el.addEventListener("input",renderList));
    renderAll();
  });
  </script>
</body>
</html>
