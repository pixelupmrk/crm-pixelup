<link rel="stylesheet" href="estilos.css" />
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRM PixelUp ‚Äî One File</title>
  <style>
    *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0a0f14;color:#eaf6ff}
    .topbar{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:#0b1520;border-bottom:1px solid #102437}
    .topbar h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.5px}
    .topbar h1 span{color:#2bb8ff;text-shadow:0 0 12px rgba(43,184,255,.6)}
    .actions{display:flex;gap:10px;align-items:center}
    .container{max-width:1100px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:18px}
    .card{background:#0d1b29;border:1px solid #102437;border-radius:14px;padding:16px;box-shadow:0 8px 40px rgba(0,0,0,.25)}
    h2{margin:0 0 12px 0;font-size:18px}
    .form-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .form-grid textarea{grid-column:1/-1;min-height:80px}
    .form-grid button{grid-column:1/-1}
    input,select,textarea{background:#0f2132;border:1px solid #17324a;border-radius:10px;padding:10px 12px;color:#d9f1ff;outline:none}
    input::placeholder,textarea::placeholder{color:#7fa8c3}
    .btn{background:#18a4ff;border:1px solid #18a4ff;color:#001727;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#0f2132;border-color:#17324a;color:#cde9ff}
    .btn.github{background:#0f2132;color:#8bd4ff;border-color:#17324a;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .list-header{display:flex;gap:12px;justify-content:space-between;align-items:center;margin-bottom:10px}
    .filters{display:flex;gap:10px}
    .table-wrap{overflow:auto;border:1px solid #102437;border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #102437;text-align:left;font-size:14px;white-space:nowrap}
    th{background:#0b1520;position:sticky;top:0}
    tr:hover{background:#0f1d2b}
    .actions-cell button{background:transparent;border:1px solid #17324a;color:#9fd9ff;padding:6px 10px;border-radius:8px;margin-right:6px;cursor:pointer}
    .actions-cell button.danger{border-color:#ff4d4d;color:#ff7878}
    .footer{padding:20px;text-align:center;color:#86c8ea;opacity:.8}
    @media (max-width:800px){.form-grid{grid-template-columns:1fr}.filters{flex-direction:column;align-items:stretch}}
    .tag{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #17324a;background:#0f2132;color:#bfe6ff}
    .tag-ganho{border-color:#27ae60;color:#8ff0b1}
    .tag-perdido{border-color:#e74c3c;color:#ffaaaa}
    .tag-proposta{border-color:#e2b93b;color:#ffe89b}
    .tag-qualificado{border-color:#2bb8ff;color:#9fe0ff}
    .tag-novo{border-color:#8e44ad;color:#dcb8ff}
    .warn{background:#2b1a00;border:1px solid #5a3b00;color:#ffd699;padding:10px;border-radius:10px;margin-bottom:12px;display:none}
  </style>
</head>
<body>
  <header class="topbar">
    <h1>CRM <span>PixelUp</span></h1>
    <div class="actions">
      <button id="exportCsvBtn" class="btn">Exportar CSV</button>
      <label class="btn secondary">
        Importar JSON
        <input id="importJsonInput" type="file" accept="application/json" hidden>
      </label>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div id="lsWarning" class="warn">‚ö†Ô∏è Salvamento desativado pelo navegador (modo privado ou cookies/localStorage bloqueados). Seus dados n√£o ser√£o persistidos.</div>
      <h2>Novo Lead</h2>
      <form id="leadForm" class="form-grid">
        <input id="name" placeholder="Nome" required />
        <input id="email" type="email" placeholder="E-mail" />
        <input id="phone" placeholder="WhatsApp" />
        <select id="stage">
          <option value="novo">Novo</option>
          <option value="qualificado">Qualificado</option>
          <option value="proposta">Proposta</option>
          <option value="ganho">Ganho</option>
          <option value="perdido">Perdido</option>
        </select>
        <input id="source" placeholder="Origem (Instagram, Indica√ß√£o...)" />
        <textarea id="notes" placeholder="Notas"></textarea>
        <button class="btn" type="submit">Salvar</button>
      </form>
    </section>

    <section class="card">
      <div class="list-header">
        <h2>Leads</h2>
        <div class="filters">
          <input id="search" placeholder="Buscar por nome, e-mail, telefone..." />
          <select id="filterStage">
            <option value="">Todos os est√°gios</option>
            <option value="novo">Novo</option>
            <option value="qualificado">Qualificado</option>
            <option value="proposta">Proposta</option>
            <option value="ganho">Ganho</option>
            <option value="perdido">Perdido</option>
          </select>
        </div>
      </div>

      <div class="table-wrap">
        <table id="leadsTable">
          <thead>
            <tr>
              <th data-sort="name">Nome</th>
              <th data-sort="email">E-mail</th>
              <th data-sort="phone">WhatsApp</th>
              <th data-sort="stage">Est√°gio</th>
              <th data-sort="source">Origem</th>
              <th data-sort="updatedAt">Atualizado</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="footer">
    <p>Feito com üíô pela PixelUp ‚Äî Demo localStorage (sem backend)</p>
  </footer>

  <script>
  (function(){
    const LS_KEY = "pixelup_crm_leads_v1";
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    const form = $("#leadForm");
    const tbody = $("#leadsTable tbody");
    const search = $("#search");
    const filterStage = $("#filterStage");
    const exportCsvBtn = $("#exportCsvBtn");
    const importJsonInput = $("#importJsonInput");
    const lsWarning = $("#lsWarning");

    // Testa disponibilidade do localStorage
    let lsAvailable = true;
    try {
      const testKey = "__ls_test__";
      localStorage.setItem(testKey, "1");
      localStorage.removeItem(testKey);
    } catch (e) {
      lsAvailable = false;
      lsWarning.style.display = "block";
    }

    let leads = load();
    let sortKey = "updatedAt";
    let sortDir = "desc";

    render();

    form.addEventListener("submit", (e)=>{
      e.preventDefault();
      const lead = {
        id: (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now() + Math.random()),
        name: $("#name").value.trim(),
        email: $("#email").value.trim(),
        phone: $("#phone").value.trim(),
        stage: $("#stage").value,
        source: $("#source").value.trim(),
        notes: $("#notes").value.trim(),
        createdAt: Date.now(),
        updatedAt: Date.now()
      };
      if(!lead.name){ alert("Informe ao menos o nome."); return; }
      leads.push(lead);
      save();
      form.reset();
      render();
    });

    search.addEventListener("input", render);
    filterStage.addEventListener("change", render);

    $$("#leadsTable th[data-sort]").forEach(th=>{
      th.style.cursor = "pointer";
      th.addEventListener("click", ()=>{
        const key = th.getAttribute("data-sort");
        if(sortKey === key){ sortDir = sortDir === "asc" ? "desc" : "asc"; }
        else { sortKey = key; sortDir = "asc"; }
        render();
      });
    });

    exportCsvBtn.addEventListener("click", ()=>{
      const csv = toCSV(leads);
      download("leads.csv", csv, "text/csv;charset=utf-8;");
    });

    importJsonInput.addEventListener("change", (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(reader.result);
          if(Array.isArray(data)){
            leads = data;
            save();
            render();
            alert("Importado com sucesso!");
          }else{
            alert("JSON inv√°lido.");
          }
        }catch(err){ alert("Falha ao ler JSON."); }
      };
      reader.readAsText(file);
    });

    function render(){
      const q = (search.value || "").toLowerCase();
      const stage = filterStage.value;
      const filtered = leads
        .filter(l => (!stage || l.stage===stage))
        .filter(l => (
          (l.name||'').toLowerCase().includes(q) ||
          (l.email||'').toLowerCase().includes(q) ||
          (l.phone||'').toLowerCase().includes(q) ||
          (l.source||"").toLowerCase().includes(q) ||
          (l.notes||"").toLowerCase().includes(q)
        ))
        .sort((a,b)=>{
          const A = a[sortKey] ?? "";
          const B = b[sortKey] ?? "";
          if(A < B) return sortDir==="asc" ? -1 : 1;
          if(A > B) return sortDir==="asc" ? 1 : -1;
          return 0;
        });

      tbody.innerHTML = "";
      for(const l of filtered){
        const tr = document.createElement("tr");
        tr.innerHTML = \`
          <td>\${escape(l.name||"")}</td>
          <td>\${escape(l.email||"")}</td>
          <td>\${escape(l.phone||"")}</td>
          <td><span class="tag tag-\${escape(l.stage||"novo")}">\${escape(l.stage||"novo")}</span></td>
          <td>\${escape(l.source||"")}</td>
          <td>\${new Date(l.updatedAt).toLocaleString()}</td>
          <td class="actions-cell">
            <button data-edit="\${l.id}">Editar</button>
            <button class="danger" data-del="\${l.id}">Excluir</button>
          </td>
        \`;
        tbody.appendChild(tr);
      }

      tbody.querySelectorAll("button[data-edit]").forEach(btn=>{
        btn.addEventListener("click", ()=> editLead(btn.getAttribute("data-edit")));
      });
      tbody.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=> deleteLead(btn.getAttribute("data-del")));
      });
    }

    function editLead(id){
      const l = leads.find(x=>x.id===id);
      if(!l) return;
      const name = prompt("Nome:", l.name); if(name===null) return;
      const email = prompt("E-mail:", l.email||""); if(email===null) return;
      const phone = prompt("WhatsApp:", l.phone||""); if(phone===null) return;
      const stage = prompt("Est√°gio (novo, qualificado, proposta, ganho, perdido):", l.stage)||l.stage;
      const source = prompt("Origem:", l.source||""); if(source===null) return;
      const notes = prompt("Notas:", l.notes||""); if(notes===null) return;
      Object.assign(l, {name,email,phone,stage,source,notes, updatedAt: Date.now()});
      save(); render();
    }

    function deleteLead(id){
      if(!confirm("Excluir este lead?")) return;
      leads = leads.filter(l=>l.id!==id);
      save(); render();
    }

    function save(){
      if(!lsAvailable) return; // n√£o quebra em modo privado
      try { localStorage.setItem(LS_KEY, JSON.stringify(leads)); }
      catch (e) { console.warn("Falha ao salvar no localStorage", e); }
    }
    function load(){
      if(!lsAvailable) return [];
      try{ return JSON.parse(localStorage.getItem(LS_KEY)) || []; }
      catch{ return []; }
    }

    function toCSV(arr){
      const headers = ["id","name","email","phone","stage","source","notes","createdAt","updatedAt"];
      const lines = [headers.join(",")];
      for(const l of arr){
        const row = headers.map(h=>csvEscape(l[h]));
        lines.push(row.join(","));
      }
      return lines.join("\n");
    }
    function csvEscape(val){
      if(val===undefined || val===null) return "";
      const s = String(val).replace(/"/g,'""');
      return /[",\n]/.test(s) ? \""\${s}\"" : s;
    }
    function download(filename, content, mime){
      const blob = new Blob([content], {type: mime||"text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }
    function escape(str=""){
      return str.replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      })[m]);
    }
  })();
  </script>
</body>
</html>
