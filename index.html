<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRM PixelUp ‚Äî Lista + Kanban + Login</title>

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(rgba(8,12,18,.82), rgba(8,12,18,.82)), url('pixelup-bg.jpg') center/cover fixed no-repeat;
      color:#eaf6ff;
    }
    .topbar{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:rgba(11,21,32,.75);border-bottom:1px solid #102437;backdrop-filter:blur(4px)}
    .topbar h1{margin:0;font-size:20px;font-weight:700}
    .topbar h1 span{color:#2bb8ff;text-shadow:0 0 14px rgba(43,184,255,.65)}
    .container{max-width:1200px;margin:24px auto;padding:0 16px;display:grid;gap:18px}
    .card{background:rgba(13,27,41,.85);backdrop-filter:blur(2px);border:1px solid #102437;border-radius:14px;padding:16px;box-shadow:0 8px 40px rgba(0,0,0,.25)}
    h2{margin:0 0 12px;font-size:18px}

    .form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .form-grid textarea{grid-column:1/-1;min-height:80px}
    .form-grid button{grid-column:1/-1}
    input,select,textarea{background:#0f2132;border:1px solid #17324a;border-radius:10px;padding:10px 12px;color:#d9f1ff;outline:none}
    input::placeholder,textarea::placeholder{color:#7fa8c3}
    .btn{background:#18a4ff;border:1px solid #18a4ff;color:#001727;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border-color:#17324a;color:#cde9ff}

    .list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px;flex-wrap:wrap}
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .filter-dates{display:flex;gap:8px;align-items:center}

    .table-wrap{overflow-x:auto;border:1px solid #102437;border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th{padding:10px;border-bottom:1px solid #102437;text-align:left;font-size:14px;white-space:nowrap;background:#0b1520;position:sticky;top:0}
    td{padding:10px;border-bottom:1px solid #102437;text-align:left;font-size:14px}
    tr:hover{background:#0f1d2b}
    tr.clickable{cursor:pointer}
    .actions-cell button{background:transparent;border:1px solid #17324a;color:#9fd9ff;padding:6px 10px;border-radius:8px;margin-right:6px;cursor:pointer}
    a.quick{color:#9fd9ff;text-decoration:underline}
    a.quick:hover{text-decoration:none;opacity:.9}

    .qual-badge{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:999px;font-size:12px;font-weight:600;border:1px solid #17324a;background:#0b1a27;color:#cde9ff}
    .q-quente{background:#3b0d0d;color:#ffd1d1;border-color:#5c1a1a}
    .q-morno{background:#3b2a0d;color:#ffe6b0;border-color:#6b4a12}
    .q-frio{ background:#0d264a;color:#d5e6ff;border-color:#123b70}

    .view-switch{display:flex;gap:8px;align-items:center;margin:0 0 8px;flex-wrap:wrap}
    .view-switch .tab{background:#0f2132;border:1px solid #17324a;color:#cde9ff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .view-switch .tab.active{background:#18a4ff;border-color:#18a4ff;color:#001727;font-weight:700}

    /* Kanban */
    .kanban{display:none;gap:12px;align-items:flex-start}
    .kanban.visible{display:grid;grid-template-columns:repeat(5,1fr)}
    .kcol{background:rgba(13,27,41,.9);border:1px solid #102437;border-radius:12px;min-height:300px;max-height:70vh;display:flex;flex-direction:column}
    .khead{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #102437}
    .khead .title{font-weight:700}
    .khead .count{background:#0f2132;border:1px solid #17324a;border-radius:999px;padding:2px 8px;font-size:12px}
    .kbody{padding:10px;overflow:auto;flex:1;display:flex;flex-direction:column;gap:8px}

    .kcard{position:relative;background:#0f2132;border:1px solid #17324a;border-radius:10px;padding:10px;cursor:grab;overflow:hidden}
    .kcard:active{cursor:grabbing}
    .kcard.dragging{opacity:.8}
    .kdrop{outline:2px dashed #18a4ff;outline-offset:-6px}
    .kcard .name{font-weight:600;margin-bottom:2px}
    .kcard .meta{opacity:.8}

    .drag-handle{
      position:absolute;bottom:6px;right:6px;font-size:14px;line-height:1;
      background:#0b1520;border:1px solid #17324a;border-radius:8px;padding:3px 6px;user-select:none;cursor:grab
    }
    .drag-handle:active{cursor:grabbing}

    .kcol[data-stage="novo"]{border-color:#3b82f6}
    .kcol[data-stage="qualificado"]{border-color:#a855f7}
    .kcol[data-stage="proposta"]{border-color:#f59e0b}
    .kcol[data-stage="vendido"]{border-color:#22c55e}
    .kcol[data-stage="perdido"]{border-color:#ef4444}
    .kcol[data-stage] .khead .count{color:#9fd9ff}
    .kcol[data-stage="novo"] .khead .title{color:#60a5fa}
    .kcol[data-stage="qualificado"] .khead .title{color:#c084fc}
    .kcol[data-stage="proposta"] .khead .title{color:#fbbf24}
    .kcol[data-stage="vendido"] .khead .title{color:#34d399}
    .kcol[data-stage="perdido"] .khead .title{color:#f87171}

    .wa-icon{position:absolute;top:6px;right:6px;z-index:50;display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#25D366;border:1px solid #0b1a27;box-shadow:0 2px 4px rgba(0,0,0,.4)}
    .wa-icon svg{width:14px;height:14px;display:block;fill:#fff}

    .edit-btn{
      position:absolute;top:6px;left:6px;
      background:#0f2132;border:1px solid #17324a;color:#cde9ff;
      border-radius:8px;padding:4px 6px;cursor:pointer;font-size:12px
    }

    @media (max-width:1000px){.kanban.visible{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:600px){.kanban.visible{grid-template-columns:1fr}}

    /* Dialog */
    dialog.px-modal{
      width:min(94vw,640px);
      max-height:90vh;
      border:none;border-radius:14px;padding:18px;
      background:#0f2132;color:#eaf6ff;box-shadow:0 10px 40px rgba(0,0,0,.5);
      overflow:auto;
    }
    dialog.px-modal::backdrop{background:rgba(0,0,0,.6);backdrop-filter:blur(1px)}
    .modal-header{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .modal-header h3{margin:0;font-size:18px}
    .modal-actions{display:flex;gap:8px}
    .modal-close{background:transparent;border:1px solid #17324a;color:#cde9ff;border-radius:10px;padding:6px 10px;cursor:pointer}
    .dl{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-top:8px}
    .dl b{color:#9fd9ff}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;opacity:.9}
    .edit-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .edit-grid textarea{grid-column:1/-1;min-height:100px}
    .wa-block{margin-top:12px;border-top:1px solid #17324a;padding-top:10px;display:grid;gap:8px}
    .wa-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    /* Dashboard */
    .dash-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px}
    .kpi{background:#0f2132;border:1px solid #17324a;border-radius:12px;padding:12px}
    .kpi .kpi-label{font-size:12px;opacity:.8;margin-bottom:6px}
    .kpi .kpi-value{font-size:26px;font-weight:800}
    .dash-panels{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .panel{background:#0f2132;border:1px solid #17324a;border-radius:12px;padding:12px}
    .panel h3{margin:0 0 10px;font-size:16px}
    .bar{background:#0b1520;border:1px solid #17324a;border-radius:999px;overflow:hidden;height:10px}
    .bar > div{height:10px;background:#18a4ff}
    .row{display:grid;grid-template-columns:140px 1fr 60px;gap:8px;align-items:center;margin:8px 0}
    .mini-table{width:100%;border-collapse:collapse}
    .mini-table th,.mini-table td{border-bottom:1px solid #102437;padding:8px;text-align:left;font-size:13px}

    @media (max-width:900px){.dash-grid{grid-template-columns:1fr}.dash-panels{grid-template-columns:1fr}}
    .status{margin-top:8px;font-size:12px;opacity:.85}
    .status.ok{color:#9fe870}
    .status.warn{color:#ffd166}
    .status.err{color:#ff7b7b}
  </style>
</head>
<body>
  <header class="topbar"><h1>CRM <span>PixelUp</span></h1></header>

  <!-- LOGIN -->
  <section id="authCard" class="card" style="max-width:420px;margin:24px auto;display:none">
    <h2>Acessar CRM</h2>
    <form id="authForm" class="form-grid" style="grid-template-columns:1fr">
      <input id="authEmail" type="email" placeholder="E-mail" required />
      <input id="authPass" type="password" placeholder="Senha (m√≠n. 6)" required minlength="6" autocomplete="new-password" />
      <button class="btn" type="submit">Entrar</button>
      <button class="btn ghost" type="button" id="btnRegister">Criar conta</button>
      <button class="btn ghost" type="button" id="btnForgot">Esqueci a senha</button>
    </form>
    <div id="authMsg" class="status" style="margin-top:8px"></div>
  </section>

  <!-- Barra usu√°rio -->
  <div id="userBar" style="display:none;max-width:1200px;margin:0 auto;padding:0 16px">
    <div class="status ok" style="text-align:right">
      Logado como <b id="ubEmail"></b> ‚Ä¢ <button id="btnLogout" class="btn ghost" type="button">Sair</button>
    </div>
  </div>

  <!-- APP -->
  <main class="container" id="app" style="display:none">
    <!-- Form -->
    <section class="card">
      <h2>Novo Lead</h2>
      <form id="leadForm" class="form-grid">
        <input id="name" placeholder="Nome" required />
        <input id="email" type="email" placeholder="E-mail" />
        <input id="phone" placeholder="WhatsApp" />
        <select id="stage">
          <option value="novo">Novo</option>
          <option value="qualificado">Qualificado</option>
          <option value="proposta">Proposta</option>
          <option value="vendido">Vendido</option>
          <option value="perdido">Perdido</option>
        </select>
        <input id="owner" placeholder="Atendente (quem atende)" />
        <input id="source" placeholder="Origem" />
        <input id="date" type="date" />
        <select id="qualif">
          <option value="">Qualifica√ß√£o</option>
          <option value="quente">Led Quente</option>
          <option value="morno">Led Morno</option>
          <option value="frio">Led Frio</option>
        </select>
        <textarea id="notes" placeholder="Notas"></textarea>
        <button class="btn" type="submit">Salvar</button>
      </form>
      <div id="storageStatus" class="status"></div>
    </section>

    <!-- Lista + Kanban + Dashboard -->
    <section class="card">
      <div class="list-header">
        <h2>Leads</h2>
        <div class="filters">
          <input id="search" placeholder="Buscar..." />
          <select id="filterOwner"><option value="">Todos atendentes</option></select>
          <select id="filterQualif">
            <option value="">Todas qualifica√ß√µes</option>
            <option value="quente">Led Quente</option>
            <option value="morno">Led Morno</option>
            <option value="frio">Led Frio</option>
          </select>
          <div class="filter-dates">
            <span>De</span><input id="filterStart" type="date">
            <span>At√©</span><input id="filterEnd" type="date">
          </div>
          <button id="btnTemplate" class="btn ghost">Configurar mensagem padr√£o</button>
          <button id="exportCsv" class="btn">Exportar CSV</button>
        </div>
      </div>

      <div class="view-switch">
        <button id="tabDashboard" class="tab">Dashboard</button>
        <button id="tabList" class="tab active">Lista</button>
        <button id="tabKanban" class="tab">Kanban</button>
      </div>

      <!-- DASHBOARD -->
      <div id="dashboard" style="display:none">
        <div class="dash-grid">
          <div class="kpi"><div class="kpi-label">Total de Leads</div><div class="kpi-value" id="kpiTotal">0</div></div>
          <div class="kpi"><div class="kpi-label">Vendas (Vendido)</div><div class="kpi-value" id="kpiVendido">0</div></div>
          <div class="kpi"><div class="kpi-label">Taxa de Convers√£o</div><div class="kpi-value" id="kpiConv">0%</div></div>
        </div>

        <div class="dash-panels">
          <div class="panel"><h3>Por Est√°gio</h3><div id="dashStages"></div></div>
          <div class="panel"><h3>Por Qualifica√ß√£o</h3><div id="dashQualif"></div></div>
          <div class="panel" style="grid-column:1/-1">
            <h3>Leads por Atendente</h3>
            <table class="mini-table" id="dashOwners">
              <thead><tr><th>Atendente</th><th>Total</th><th>Vendido</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- LISTA -->
      <div class="table-wrap" id="tableWrap">
        <table id="leadsTable">
          <thead>
            <tr>
              <th>Nome</th><th>E-mail</th><th>WhatsApp</th><th>Atendente</th>
              <th>Est√°gio</th><th>Origem</th><th>Data</th><th>Qualifica√ß√£o</th><th>Atualizado</th><th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- KANBAN -->
      <div id="kanban" class="kanban">
        <div class="kcol" data-stage="novo"><div class="khead"><span class="title">Novo</span><span class="count" id="count-novo">0</span></div><div class="kbody" id="col-novo"></div></div>
        <div class="kcol" data-stage="qualificado"><div class="khead"><span class="title">Qualificado</span><span class="count" id="count-qualificado">0</span></div><div class="kbody" id="col-qualificado"></div></div>
        <div class="kcol" data-stage="proposta"><div class="khead"><span class="title">Proposta</span><span class="count" id="count-proposta">0</span></div><div class="kbody" id="col-proposta"></div></div>
        <div class="kcol" data-stage="vendido"><div class="khead"><span class="title">Vendido</span><span class="count" id="count-vendido">0</span></div><div class="kbody" id="col-vendido"></div></div>
        <div class="kcol" data-stage="perdido"><div class="khead"><span class="title">Perdido</span><span class="count" id="count-perdido">0</span></div><div class="kbody" id="col-perdido"></div></div>
      </div>
    </section>
  </main>

  <!-- ===== SCRIPT DO CRM ===== -->
  <script>
  document.addEventListener("DOMContentLoaded", function(){
    const storageStatus = document.getElementById("storageStatus");
    const setStatus = (msg, cls)=>{ storageStatus.textContent=msg; storageStatus.className="status "+(cls||""); };

    // storage robusto
    const memory={}; let storeType="localStorage";
    const store={
      getItem(k){try{const v=localStorage.getItem(k);if(v!=null)return v;}catch(_){}try{const v=sessionStorage.getItem(k);if(v!=null)return v;}catch(_){}return Object.prototype.hasOwnProperty.call(memory,k)?memory[k]:null;},
      setItem(k,v){let ok=false;try{localStorage.setItem(k,v);ok=true;}catch(_){}try{sessionStorage.setItem(k,v);ok=true;if(!ok)storeType="sessionStorage";}catch(_){}if(!ok){memory[k]=v;storeType="memory";}return ok;},
      removeItem(k){try{localStorage.removeItem(k);}catch(_){}try{sessionStorage.removeItem(k);}catch(_){}delete memory[k];}
    };
    (function(){try{localStorage.setItem("__t","1");localStorage.removeItem("__t");storeType="localStorage";setStatus("Armazenamento: localStorage ativo ‚úÖ","ok");}
    catch(e1){try{sessionStorage.setItem("__t","1");sessionStorage.removeItem("__t");storeType="sessionStorage";setStatus("Aviso: usando sessionStorage.","warn");}
    catch(e2){storeType="memory";setStatus("Erro: armazenamento bloqueado (somente mem√≥ria).","err");}}})();

    // chaves por usu√°rio (vem do script de Auth)
    const LSKEY = ()=> (window.getLSKey?window.getLSKey():"pixelup_crm_leads_v1_guest");
    const TPLKEY= ()=> (window.getTplKey?window.getTplKey():"pixelup_crm_wa_template_v1_guest");

    const getJSON=(k,d)=>{try{const v=store.getItem(k);return v?JSON.parse(v):d;}catch(_){return d;}};
    const setJSON=(k,v)=>{try{const s=JSON.stringify(v);const ok=store.setItem(k,s);if(!ok)throw 0;return true;}catch(_){setStatus("Erro ao salvar.","err");return false;}};

    let waTemplate = store.getItem(TPLKEY()) || "Ol√° {{nome}}! Aqui √© {{atendente}} da PixelUp. Vi seu contato via {{origem}} ({{qualificacao}}). Podemos falar?";
    let leads = getJSON(LSKEY(), []);

    const esc = s=>String(s||"").replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const digits = s=>String(s||"").replace(/\D/g,'');
    function parseDateTs(str,end){if(!str)return null;let y,m,d; if(str.includes("-")){[y,m,d]=str.split("-");y=+y;m=+m-1;d=+d;}else if(str.includes("/")){[d,m,y]=str.split("/");d=+d;m=+m-1;y=+y;} else return null; return new Date(y,m,d,end?23:0,end?59:0,end?59:0,end?999:0).getTime();}
    const qualName=q=>q==="quente"?"Led Quente":q==="morno"?"Led Morno":q==="frio"?"Led Frio":"";
    const qualClass=q=>q?("q-"+q):"";
    function buildMsg(tpl,lead){const map={"{{nome}}":lead.name||"","{{email}}":lead.email||"","{{whatsapp}}":lead.phone||"","{{atendente}}":lead.owner||"","{{origem}}":lead.source||"","{{estagio}}":lead.stage||"","{{data}}":lead.date||"","{{qualificacao}}":qualName(lead.qualif)||""};let out=tpl;for(const k in map){out=out.split(k).join(map[k]);}return out;}

    const form=document.getElementById("leadForm");
    const tbody=document.querySelector("#leadsTable tbody");
    const search=document.getElementById("search");
    const fOwner=document.getElementById("filterOwner");
    const fQualif=document.getElementById("filterQualif");
    const fStart=document.getElementById("filterStart");
    const fEnd=document.getElementById("filterEnd");
    const exportBtn=document.getElementById("exportCsv");
    const btnTemplate=document.getElementById("btnTemplate");
    const tabDashboard=document.getElementById("tabDashboard");
    const tabList=document.getElementById("tabList");
    const tabKanban=document.getElementById("tabKanban");
    const dashboard=document.getElementById("dashboard");
    const tableWrap=document.getElementById("tableWrap");
    const kanbanEl=document.getElementById("kanban");

    function showLeadDetails(lead){
      document.querySelectorAll("dialog.px-modal").forEach(d=>d.close());
      const wa=digits(lead.phone||"");
      const dlg=document.createElement("dialog");
      dlg.className="px-modal";
      dlg.innerHTML=`
        <div class="modal-header">
          <h3>Detalhes do Lead</h3>
          <div class="modal-actions">
            <button class="btn ghost" id="editBtn">Editar</button>
            <button class="modal-close" id="closeModalBtn">Fechar</button>
          </div>
        </div>
        <div id="detailsView" class="dl">
          <b>Nome</b><div>${esc(lead.name)}</div>
          <b>E-mail</b><div>${esc(lead.email||"")}${lead.email?` &nbsp; <a class="quick" href="mailto:${encodeURIComponent(lead.email)}">Enviar</a>`:''}</div>
          <b>WhatsApp</b><div class="mono">${esc(lead.phone||"")}${wa?` &nbsp; <a class="quick" href="https://wa.me/${wa}" target="_blank">Abrir</a>`:''}</div>
          <b>Atendente</b><div>${esc(lead.owner||"")}</div>
          <b>Est√°gio</b><div>${esc(lead.stage)}</div>
          <b>Origem</b><div>${esc(lead.source||"")}</div>
          <b>Data</b><div>${esc(lead.date||"")}</div>
          <b>Qualifica√ß√£o</b><div><span class="qual-badge ${qualClass(lead.qualif)}">${qualName(lead.qualif)||"-"}</span></div>
          <b>Criado</b><div>${new Date(lead.createdAt).toLocaleString()}</div>
          <b>Atualizado</b><div>${new Date(lead.updatedAt).toLocaleString()}</div>
          <b>Notas</b><div style="white-space:pre-wrap">${esc(lead.notes||"-")}</div>
        </div>

        <div class="wa-block">
          <div class="wa-row">
            <select id="waPreset">
              <option value="">Selecione um modelo r√°pido‚Ä¶</option>
              <option value="oi">Oi + apresenta√ß√£o</option>
              <option value="proposta">Envio de proposta</option>
              <option value="follow">Follow-up</option>
            </select>
            <button class="btn ghost" id="useDefault">Usar padr√£o</button>
            <button class="btn" id="openWa">Abrir no WhatsApp</button>
          </div>
          <textarea id="waText" placeholder="Mensagem que ser√° enviada no WhatsApp"></textarea>
          <small>Placeholders: {{nome}}, {{email}}, {{whatsapp}}, {{atendente}}, {{origem}}, {{estagio}}, {{data}}, {{qualificacao}}</small>
        </div>

        <form id="editForm" class="edit-grid" style="display:none;margin-top:8px">
          <input id="e_name" placeholder="Nome"/>
          <input id="e_email" placeholder="E-mail"/>
          <input id="e_phone" placeholder="WhatsApp"/>
          <input id="e_owner" placeholder="Atendente"/>
          <select id="e_stage">
            <option value="novo">Novo</option><option value="qualificado">Qualificado</option>
            <option value="proposta">Proposta</option><option value="vendido">Vendido</option><option value="perdido">Perdido</option>
          </select>
          <input id="e_source" placeholder="Origem"/>
          <input id="e_date" type="date"/>
          <select id="e_qualif"><option value="">Qualifica√ß√£o</option><option value="quente">Led Quente</option><option value="morno">Led Morno</option><option value="frio">Led Frio</option></select>
          <textarea id="e_notes" placeholder="Notas"></textarea>
          <div style="grid-column:1/-1;display:flex;gap:8px;justify-content:flex-end">
            <button type="button" class="btn ghost" id="cancelEdit">Cancelar</button>
            <button type="submit" class="btn">Salvar altera√ß√µes</button>
          </div>
        </form>
      `;
      const close=()=>{dlg.close();dlg.remove();};
      dlg.addEventListener("close",()=>dlg.remove());
      dlg.querySelector("#closeModalBtn").addEventListener("click",close);
      dlg.addEventListener("click",(e)=>{const r=dlg.getBoundingClientRect();if(!(e.clientX>=r.left&&e.clientX<=r.right&&e.clientY>=r.top&&e.clientY<=r.bottom))close();});

      // WA
      const waText=dlg.querySelector("#waText");
      const quicks={oi:"Ol√° {{nome}}, tudo bem? Aqui √© {{atendente}} da PixelUp ({{qualificacao}}). Recebemos seu contato via {{origem}} üôÇ",proposta:"Oi {{nome}}! Enviei a proposta no seu e-mail {{email}} ({{qualificacao}}). Se preferir, resumo por aqui.",follow:"Oi {{nome}}, viu nossa proposta? Fico √† disposi√ß√£o. ({{qualificacao}})"};
      const fillDefault=()=>waText.value=buildMsg(waTemplate,lead); fillDefault();
      dlg.querySelector("#waPreset").addEventListener("change",ev=>{const k=ev.target.value;waText.value=k?buildMsg(quicks[k],lead):"";});
      dlg.querySelector("#useDefault").addEventListener("click",fillDefault);
      dlg.querySelector("#openWa").addEventListener("click",()=>{const num=digits(lead.phone||"");if(!num){alert("Este lead n√£o tem WhatsApp v√°lido.");return;}const text=encodeURIComponent(waText.value||buildMsg(waTemplate,lead));window.open(`https://wa.me/${num}?text=${text}`,"_blank");});

      // Editar
      const details=dlg.querySelector("#detailsView");
      const formE=dlg.querySelector("#editForm");
      dlg.querySelector("#editBtn").addEventListener("click",()=>{formE.querySelector("#e_name").value=lead.name||"";formE.querySelector("#e_email").value=lead.email||"";formE.querySelector("#e_phone").value=lead.phone||"";formE.querySelector("#e_owner").value=lead.owner||"";formE.querySelector("#e_stage").value=lead.stage||"novo";formE.querySelector("#e_source").value=lead.source||"";formE.querySelector("#e_date").value=lead.date||"";formE.querySelector("#e_qualif").value=lead.qualif||"";formE.querySelector("#e_notes").value=lead.notes||"";details.style.display="none";formE.style.display="grid";});
      formE.querySelector("#cancelEdit").addEventListener("click",()=>{formE.reset();formE.style.display="none";details.style.display="grid";});
      formE.addEventListener("submit",(ev)=>{ev.preventDefault();lead.name=formE.querySelector("#e_name").value.trim();lead.email=formE.querySelector("#e_email").value.trim();lead.phone=formE.querySelector("#e_phone").value.trim();lead.owner=formE.querySelector("#e_owner").value.trim();lead.stage=formE.querySelector("#e_stage").value;lead.source=formE.querySelector("#e_source").value.trim();lead.date=formE.querySelector("#e_date").value;lead.qualif=formE.querySelector("#e_qualif").value;lead.notes=formE.querySelector("#e_notes").value.trim();lead.updatedAt=Date.now();if(setJSON(LSKEY(),leads)){setStatus("Altera√ß√µes salvas ‚úÖ","ok");}close();renderAll();});

      document.body.appendChild(dlg); dlg.showModal();
    }

    // LISTA
    function populateOwnerFilter(){const selected=fOwner.value;const owners=[...new Set(leads.map(l=>l.owner).filter(Boolean))].sort();fOwner.innerHTML=['<option value="">Todos atendentes</option>',...owners.map(o=>`<option ${o===selected?'selected':''} value="${o}">${o}</option>`)].join('');}
    function renderList(){
      tbody.innerHTML="";const q=(search?.value||"").toLowerCase();const owner=fOwner?.value||"";const qual=fQualif?.value||"";const sTs=parseDateTs(fStart?.value);const eTs=parseDateTs(fEnd?.value,true);
      const filtered=leads.filter(l=>{const txt=((l.name||"")+" "+(l.email||"")+" "+(l.phone||"")+" "+(l.owner||"")+" "+(l.source||"")+" "+(l.notes||"")+" "+(qualName(l.qualif))).toLowerCase();const d=l.date?parseDateTs(l.date):l.updatedAt;if(q&&!txt.includes(q))return false;if(owner&&(l.owner||"")!==owner)return false;if(qual&&(l.qualif||"")!==qual)return false;if(sTs&&d<sTs)return false;if(eTs&&d>eTs)return false;return true;});
      for(const l of filtered){
        const tr=document.createElement("tr"); tr.className="clickable"; tr.dataset.id=l.id;
        const mailCell=l.email?`<a class="quick" href="mailto:${encodeURIComponent(l.email)}" onclick="event.stopPropagation()">${l.email}</a>`:"";
        const waDigits=digits(l.phone||""); const waCell=waDigits?`<a class="quick" href="https://wa.me/${waDigits}" target="_blank" rel="noopener" onclick="event.stopPropagation()">${l.phone}</a>`:(l.phone||"");
        tr.innerHTML=`<td>${l.name||""}</td><td>${mailCell}</td><td>${waCell}</td><td>${l.owner||""}</td><td>${l.stage||""}</td><td>${l.source||""}</td><td>${l.date||""}</td><td><span class="qual-badge ${qualClass(l.qualif)}">${qualName(l.qualif)||""}</span></td><td>${new Date(l.updatedAt).toLocaleString()}</td>`;
        const td=document.createElement("td"); td.className="actions-cell"; const del=document.createElement("button"); del.textContent="Excluir";
        del.addEventListener("click",(ev)=>{ev.stopPropagation();leads=leads.filter(x=>x.id!==l.id);if(setJSON(LSKEY(),leads)){setStatus("Lead exclu√≠do ‚úÖ","ok");}renderAll();});
        td.appendChild(del); tr.appendChild(td); tbody.appendChild(tr);
      }
      populateOwnerFilter();
    }
    document.querySelector("#leadsTable tbody").addEventListener("click",(e)=>{if(e.target.closest(".actions-cell"))return;const tr=e.target.closest("tr");if(!tr)return;const lead=leads.find(x=>x.id===tr.dataset.id);if(lead)showLeadDetails(lead);});
    fOwner.addEventListener("change",renderList); fQualif.addEventListener("change",renderList);

    // KANBAN
    const STAGES=["novo","qualificado","proposta","vendido","perdido"];
    function renderKanban(){
      for(const stage of STAGES){
        const body=document.getElementById("col-"+stage), count=document.getElementById("count-"+stage);
        body.innerHTML=""; const items=leads.filter(x=>(x.stage||"novo")===stage); count.textContent=items.length;
        for(const l of items){
          const card=document.createElement("div"); card.className="kcard"; card.draggable=true; card.dataset.id=l.id; card.tabIndex=0;
          const edit=document.createElement("button"); edit.type="button"; edit.className="edit-btn"; edit.title="Editar"; edit.innerHTML="‚úèÔ∏è"; edit.addEventListener("click",(ev)=>{ev.stopPropagation();showLeadDetails(l);setTimeout(()=>{document.querySelector('dialog.px-modal #editBtn')?.click();},0);}); card.appendChild(edit);
          const nameEl=document.createElement("div"); nameEl.className="name"; nameEl.textContent=l.name||""; const meta=document.createElement("div"); meta.className="meta"; meta.textContent=(l.email||""); card.appendChild(nameEl); card.appendChild(meta);
          if(l.owner){const m=document.createElement("div");m.className="meta";m.textContent="Atendente: "+l.owner;card.appendChild(m);}
          if(l.qualif){const qb=document.createElement("span");qb.className="qual-badge "+qualClass(l.qualif);qb.textContent=qualName(l.qualif);card.appendChild(qb);}
          const handle=document.createElement("div"); handle.className="drag-handle"; handle.title="Arrastar para outra coluna"; handle.textContent="‚†ø"; card.appendChild(handle);
          card.addEventListener("dragstart",e=>{if(e.dataTransfer){e.dataTransfer.effectAllowed="move";try{e.dataTransfer.setData("text/plain",card.dataset.id);}catch(_){}}card.classList.add("dragging");});
          card.addEventListener("dragend",()=>card.classList.remove("dragging"));
          card.addEventListener("click",()=>showLeadDetails(l));
          body.appendChild(card);
        }
      }
      document.querySelectorAll(".kbody").forEach(col=>{
        col.addEventListener("dragover",e=>{e.preventDefault(); if(e.dataTransfer) e.dataTransfer.dropEffect="move"; col.classList.add("kdrop");});
        col.addEventListener("dragleave",()=>col.classList.remove("kdrop"));
        col.addEventListener("drop",e=>{e.preventDefault(); col.classList.remove("kdrop"); const dragged=document.querySelector(".kcard.dragging"); const id=(e.dataTransfer&&e.dataTransfer.getData("text/plain"))||dragged?.dataset.id; if(!id)return; const l=leads.find(x=>x.id===id); if(l){const toStage=col.closest(".kcol")?.dataset.stage||col.parentElement.dataset.stage; l.stage=toStage; l.updatedAt=Date.now(); if(setJSON(LSKEY(),leads))setStatus("Lead movido ‚úÖ","ok"); renderAll();}});
      });
    }

    // Dashboard
    const pct=(p,t)=>t?Math.round((p/t)*100):0;
    function computeStats(){const total=leads.length;const vendidos=leads.filter(l=>l.stage==="vendido").length;const byStage={novo:0,qualificado:0,proposta:0,vendido:0,perdido:0};leads.forEach(l=>{byStage[l.stage||"novo]=(byStage[l.stage||"novo"]||0)+1;});const byQualif={quente:0,morno:0,frio:0,vazio:0};leads.forEach(l=>{if(!l.qualif)byQualif.vazio++;else byQualif[l.qualif]=(byQualif[l.qualif]||0)+1;});const byOwner={};leads.forEach(l=>{const o=l.owner||"(sem atendente)";if(!byOwner[o])byOwner[o]={total:0,vendido:0};byOwner[o].total++;if(l.stage==="vendido")byOwner[o].vendido++;});return {total,vendidos,conv: total?Math.round((vendidos/total)*100):0,byStage,byQualif,byOwner};}
    function renderDashboard(){const {total,vendidos,conv,byStage,byQualif,byOwner}=computeStats(); document.getElementById("kpiTotal").textContent=total; document.getElementById("kpiVendido").textContent=vendidos; document.getElementById("kpiConv").textContent=conv+"%";
      const ds=document.getElementById("dashStages"); ds.innerHTML=""; [["Novo","novo"],["Qualificado","qualificado"],["Proposta","proposta"],["Vendido","vendido"],["Perdido","perdido"]].forEach(([label,key])=>{const v=byStage[key]||0;const row=document.createElement("div");row.className="row";row.innerHTML=`<div>${label}</div><div class="bar"><div style="width:${pct(v,total)}%"></div></div><div style="text-align:right">${v}</div>`;ds.appendChild(row);});
      const dq=document.getElementById("dashQualif"); dq.innerHTML=""; [["Led Quente","quente"],["Led Morno","morno"],["Led Frio","frio"],["(Sem)","vazio"]].forEach(([label,key])=>{const v=byQualif[key]||0;const row=document.createElement("div");row.className="row";row.innerHTML=`<div>${label}</div><div class="bar"><div style="width:${pct(v,total)}%"></div></div><div style="text-align:right">${v}</div>`;dq.appendChild(row);});
      const tb=document.querySelector("#dashOwners tbody"); tb.innerHTML=""; Object.entries(byOwner).sort((a,b)=>b[1].total-a[1].total).forEach(([owner,vals])=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${esc(owner)}</td><td>${vals.total}</td><td>${vals.vendido}</td>`;tb.appendChild(tr);});
    }

    // Export CSV
    function csvRow(arr){return arr.map(v=>('"'+String(v??"").replace(/"/g,'""')+'"')).join(",");}
    function downloadCsv(name,csv){const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=name;a.click();URL.revokeObjectURL(url);}
    document.getElementById("exportCsv").addEventListener("click",()=>{const headers=["id","nome","email","whatsapp","atendente","estagio","origem","data","qualificacao","notas","criado_em","atualizado_em"];const rows=[headers];const owner=fOwner?.value||"";const qual=fQualif?.value||"";const q=(search?.value||"").toLowerCase();const sTs=parseDateTs(fStart?.value);const eTs=parseDateTs(fEnd?.value,true);const filtered=leads.filter(l=>{const txt=((l.name||"")+" "+(l.email||"")+" "+(l.phone||"")+" "+(l.owner||"")+" "+(l.source||"")+" "+(l.notes||"")+" "+qualName(l.qualif)).toLowerCase();const d=l.date?parseDateTs(l.date):l.updatedAt;if(q&&!txt.includes(q))return false;if(owner&&(l.owner||"")!==owner)return false;if(qual&&(l.qualif||"")!==qual)return false;if(sTs&&d<sTs)return false;if(eTs&&d>eTs)return false;return true;}); for(const l of filtered){rows.push([l.id,l.name||"",l.email||"",l.phone||"",l.owner||"",l.stage||"",l.source||"",l.date||"",qualName(l.qualif)||"",l.notes||"",new Date(l.createdAt).toISOString(),new Date(l.updatedAt).toISOString()]);} downloadCsv(`leads_pixelup_${new Date().toISOString().slice(0,10)}.csv`, rows.map(csvRow).join("\n"));});

    // Form
    const uid=()=> (Date.now().toString(36)+Math.random().toString(36).slice(2,6)).toUpperCase();
    form.addEventListener("submit",(e)=>{e.preventDefault();const lead={id:uid(),name:document.getElementById("name").value.trim(),email:document.getElementById("email").value.trim(),phone:document.getElementById("phone").value.trim(),stage:document.getElementById("stage").value,owner:document.getElementById("owner").value.trim(),source:document.getElementById("source").value.trim(),date:document.getElementById("date").value,qualif:document.getElementById("qualif").value,notes:document.getElementById("notes").value.trim(),createdAt:Date.now(),updatedAt:Date.now()}; if(!lead.name){alert("Informe o nome");return;} leads.push(lead); if(setJSON(LSKEY(),leads)){setStatus
