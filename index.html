<script>
(function(){
  var leads = JSON.parse(localStorage.getItem("pixelup_crm_leads_v1")||"[]");
  function persist(){ localStorage.setItem("pixelup_crm_leads_v1", JSON.stringify(leads)); }

  // ===== LISTA =====
  function renderList(){
    var tbody=document.querySelector("#leadsTable tbody");
    tbody.innerHTML="";
    leads.forEach(l=>{
      var tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${l.name}</td>
        <td>${l.email||""}</td>
        <td>${l.phone||""}</td>
        <td>${l.stage}</td>
        <td>${l.source||""}</td>
        <td>${l.date||""}</td>
        <td>${new Date(l.updatedAt).toLocaleString()}</td>`;
      var td=document.createElement("td");
      var del=document.createElement("button");
      del.textContent="Excluir";
      del.onclick=()=>{leads=leads.filter(x=>x.id!==l.id);persist();renderAll();};
      td.appendChild(del);
      tr.appendChild(td);
      tbody.appendChild(tr);
    });
  }

  // ===== KANBAN =====
  function renderKanban(){
    ["novo","qualificado","proposta","ganho","perdido"].forEach(stage=>{
      var body=document.getElementById("col-"+stage);
      var count=document.getElementById("count-"+stage);
      body.innerHTML="";
      var items=leads.filter(l=>l.stage===stage);
      count.textContent=items.length;
      items.forEach(l=>{
        var c=document.createElement("div");
        c.className="kcard";
        c.draggable=true;
        c.dataset.id=l.id;
        c.innerHTML=`<div class='name'>${l.name}</div><div class='meta'>${l.email||""}</div>`;
        body.appendChild(c);
      });
    });
    bindDnD();
  }

  function bindDnD(){
    document.querySelectorAll(".kcard").forEach(card=>{
      card.addEventListener("dragstart",e=>{
        e.dataTransfer.setData("id",card.dataset.id);
      });
    });
    document.querySelectorAll(".kbody").forEach(col=>{
      col.addEventListener("dragover",e=>{ e.preventDefault(); col.classList.add("kdrop"); });
      col.addEventListener("dragleave",()=>col.classList.remove("kdrop"));
      col.addEventListener("drop",e=>{
        e.preventDefault(); col.classList.remove("kdrop");
        var id=e.dataTransfer.getData("id");
        var l=leads.find(x=>x.id===id);
        if(l){
          l.stage=col.parentElement.dataset.stage;
          l.updatedAt=Date.now();
          persist();
          renderAll();
        }
      });
    });
  }

  function renderAll(){ renderList(); renderKanban(); }

  // ===== FORM =====
  document.getElementById("leadForm").addEventListener("submit",e=>{
    e.preventDefault();
    var f=e.target;
    leads.push({
      id:Date.now().toString(),
      name:f.name.value,
      email:f.email.value,
      phone:f.phone.value,
      stage:f.stage.value,
      source:f.source.value,
      date:f.date.value,
      notes:f.notes.value,
      createdAt:Date.now(),
      updatedAt:Date.now()
    });
    persist(); f.reset(); renderAll();
  });

  // ===== TAB SWITCH =====
  var tabList=document.getElementById("tabList");
  var tabKanban=document.getElementById("tabKanban");
  var tableWrap=document.getElementById("tableWrap");
  var kanbanEl=document.getElementById("kanban");

  tabList.onclick=()=>{
    tabList.classList.add("active");
    tabKanban.classList.remove("active");
    tableWrap.style.display="block";
    kanbanEl.classList.remove("visible");
  };
  tabKanban.onclick=()=>{
    tabKanban.classList.add("active");
    tabList.classList.remove("active");
    tableWrap.style.display="none";
    kanbanEl.classList.add("visible"); // agora aplica a classe certa
    renderKanban();
  };

  // ===== INIT =====
  renderAll();
})();
</script>
