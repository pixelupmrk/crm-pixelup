<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRM PixelUp ‚Äî MVP</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0a0f14;color:#eaf6ff}
    .topbar{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:#0b1520;border-bottom:1px solid #102437}
    .topbar h1{margin:0;font-size:20px;font-weight:700}
    .topbar h1 span{color:#2bb8ff;text-shadow:0 0 12px rgba(43,184,255,.6)}
    .actions{display:flex;gap:10px;align-items:center}
    .container{max-width:1200px;margin:24px auto;padding:0 16px;display:grid;gap:18px}
    .card{background:#0d1b29;border:1px solid #102437;border-radius:14px;padding:16px;box-shadow:0 8px 40px rgba(0,0,0,.25)}
    h2{margin:0 0 12px;font-size:18px}

    .form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .form-grid textarea{grid-column:1/-1;min-height:80px}
    .form-grid button{grid-column:1/-1}
    input,select,textarea{background:#0f2132;border:1px solid #17324a;border-radius:10px;padding:10px 12px;color:#d9f1ff;outline:none}
    input::placeholder,textarea::placeholder{color:#7fa8c3}
    .btn{background:#18a4ff;border:1px solid #18a4ff;color:#001727;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#0f2132;color:#cde9ff;border-color:#17324a}

    .list-header{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between;align-items:center;margin-bottom:10px}
    .filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .filter-dates{display:flex;gap:8px;align-items:center}

    .table-wrap{overflow-x:auto;border:1px solid #102437;border-radius:12px}
    table{width:100%;border-collapse:collapse}
    /* cabe√ßalho sem quebrar */
    th{padding:10px;border-bottom:1px solid #102437;text-align:left;font-size:14px;white-space:nowrap;background:#0b1520;position:sticky;top:0;cursor:pointer}
    /* c√©lulas quebram a linha quando necess√°rio */
    td{padding:10px;border-bottom:1px solid #102437;text-align:left;font-size:14px;white-space:normal;word-break:break-word}
    tr:hover{background:#0f1d2b}

    .actions-cell a,.actions-cell button{background:transparent;border:1px solid #17324a;color:#9fd9ff;padding:6px 10px;border-radius:8px;margin-right:6px;cursor:pointer;text-decoration:none;display:inline-block}
    .actions-cell .danger{border-color:#ff4d4d;color:#ff7878}

    .footer{padding:20px;text-align:center;color:#86c8ea;opacity:.8}
    @media (max-width:900px){.form-grid{grid-template-columns:1fr}.filters{flex-direction:column;align-items:stretch}}

    .tag{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #17324a;background:#0f2132;color:#bfe6ff}
    .warn{background:#2b1a00;border:1px solid #5a3b00;color:#ffd699;padding:10px;border-radius:10px;margin-bottom:12px;display:none}
  </style>
</head>
<body>
  <header class="topbar">
    <h1>CRM <span>PixelUp</span></h1>
    <div class="actions">
      <button id="exportCsvBtn" class="btn">Exportar CSV</button>
      <label class="btn secondary">
        Importar JSON
        <input id="importJsonInput" type="file" accept="application/json" hidden>
      </label>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div id="lsWarning" class="warn">‚ö†Ô∏è Navegador bloqueou localStorage. Usando cookies.</div>
      <h2>Novo Lead</h2>
      <form id="leadForm" class="form-grid">
        <input id="name" placeholder="Nome" required />
        <input id="email" type="email" placeholder="E-mail" />
        <input id="phone" placeholder="WhatsApp" />
        <select id="stage">
          <option value="novo">Novo</option>
          <option value="qualificado">Qualificado</option>
          <option value="proposta">Proposta</option>
          <option value="ganho">Ganho</option>
          <option value="perdido">Perdido</option>
        </select>
        <input id="source" placeholder="Origem (Instagram, Indica√ß√£o...)" />
        <input id="date" type="date" />
        <textarea id="notes" placeholder="Notas"></textarea>
        <button class="btn" type="submit">Salvar</button>
      </form>
    </section>

    <section class="card">
      <div class="list-header">
        <h2>Leads</h2>
        <div class="filters">
          <input id="search" placeholder="Buscar por nome, e-mail, telefone..." />
          <select id="filterStage">
            <option value="">Todos os est√°gios</option>
            <option value="novo">Novo</option>
            <option value="qualificado">Qualificado</option>
            <option value="proposta">Proposta</option>
            <option value="ganho">Ganho</option>
            <option value="perdido">Perdido</option>
          </select>
          <div class="filter-dates">
            <span>De</span><input id="filterStart" type="date">
            <span>At√©</span><input id="filterEnd" type="date">
          </div>
        </div>
      </div>

      <div class="table-wrap">
        <table id="leadsTable">
          <thead>
            <tr>
              <th data-sort="name">Nome</th>
              <th data-sort="email">E-mail</th>
              <th data-sort="phone">WhatsApp</th>
              <th data-sort="stage">Est√°gio</th>
              <th data-sort="source">Origem</th>
              <th data-sort="date">Data</th>
              <th data-sort="createdAt">Criado em</th>
              <th data-sort="updatedAt">Atualizado</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="footer">
    <p>Feito com üíô pela PixelUp ‚Äî MVP completo</p>
  </footer>

  <script>
  (function(){
    // ===== STORAGE =====
    var LS_KEY = "pixelup_crm_leads_v1";
    var storageMode = "localStorage";
    try { localStorage.setItem("__t__","1"); localStorage.removeItem("__t__"); }
    catch(e){ storageMode = "cookie"; var w=document.getElementById("lsWarning"); if(w) w.style.display="block"; }

    function saveBlob(k,v){
      if(storageMode==="localStorage"){ try{ localStorage.setItem(k,v); }catch(e){} }
      else { document.cookie=k+"="+encodeURIComponent(v)+";path=/;max-age=31536000;samesite=lax"; }
    }
    function loadBlob(k){
      if(storageMode==="localStorage"){ try{ return localStorage.getItem(k); }catch(e){ return null; } }
      else { var m=document.cookie.match(new RegExp('(?:^|; )'+k+'=([^;]*)')); return m?decodeURIComponent(m[1]):null; }
    }

    // ===== UTILS =====
    function esc(s){ return String(s||"").replace(/[&<>\"']/g,function(m){return({"&":"&amp;","<":"&lt;","<": "&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])}); } // safe
    function formatPhoneToWa(num){
      var d=String(num||"").replace(/\D/g,"");
      if(d.length>=10&&d.length<=12&&d.indexOf("55")!==0) d="55"+d; // tenta BR
      return "https://wa.me/"+d+"?text="+encodeURIComponent("Ol√°! Vi seu cadastro no CRM PixelUp üôÇ");
    }

    // aceita "yyyy-mm-dd" ou "dd/mm/yyyy"
    function parseDateTs(str,endOfDay){
      if(!str) return null;
      var y,m,d;
      if(str.indexOf("-")>-1){ var p=str.split("-"); if(p.length!==3) return null; y=+p[0]; m=+p[1]-1; d=+p[2]; }
      else if(str.indexOf("/")>-1){ var p2=str.split("/"); if(p2.length!==3) return null; d=+p2[0]; m=+p2[1]-1; y=+p2[2]; }
      else return null;
      return new Date(y,m,d, endOfDay?23:0, endOfDay?59:0, endOfDay?59:0, endOfDay?999:0).getTime();
    }
    function formatDate(str, fbTs){
      var ts=parseDateTs(str);
      if(ts) return new Date(ts).toLocaleDateString();
      return new Date(fbTs||Date.now()).toLocaleString();
    }

    function toCSV(rows){
      var headers=["id","name","email","phone","stage","source","notes","date","createdAt","updatedAt"];
      var out=[headers.join(",")];
      rows.forEach(function(l){
        var row=headers.map(function(h){
          var v=(l[h]==null?"":String(l[h]).replace(/"/g,'""'));
          return /[",\n]/.test(v)?('"'+v+'"'):v;
        });
        out.push(row.join(","));
      });
      return out.join("\n");
    }
    function downloadFile(name,content,mime){
      var blob=new Blob([content],{type:mime||"text/plain"});
      var url=URL.createObjectURL(blob);
      var a=document.createElement("a"); a.href=url; a.download=name; a.click();
      URL.revokeObjectURL(url);
    }

    // ===== ESTADO =====
    var leads; try{ leads=JSON.parse(loadBlob(LS_KEY)||"[]"); }catch(e){ leads=[]; }
    var sortKey="updatedAt", sortDir="desc";

    // ===== DOM =====
    var form=document.getElementById("leadForm"), tbody=document.querySelector("#leadsTable tbody");
    var search=document.getElementById("search"), filterStage=document.getElementById("filterStage");
    var filterStart=document.getElementById("filterStart"), filterEnd=document.getElementById("filterEnd");
    var exportBtn=document.getElementById("exportCsvBtn"), importInp=document.getElementById("importJsonInput");

    // ===== RENDER =====
    function render(){
      var q=(search.value||"").toLowerCase();
      var st=filterStage.value;
      var sTs=parseDateTs(filterStart.value);
      var eTs=parseDateTs(filterEnd.value,true);

      var filtered=leads.filter(function(l){
        var textOk=(l.name||"").toLowerCase().includes(q)
          ||(l.email||"").toLowerCase().includes(q)
          ||(l.phone||"").toLowerCase().includes(q)
          ||(l.source||"").toLowerCase().includes(q)
          ||(l.notes||"").toLowerCase().includes(q);
        var d = l.date ? parseDateTs(l.date) : l.createdAt;
        var dateOk = (sTs==null||d>=sTs) && (eTs==null||d<=eTs);
        return (!st || l.stage===st) && textOk && dateOk;
      }).sort(function(a,b){
        var A=a[sortKey]||0, B=b[sortKey]||0;
        if(A<B) return (sortDir==="asc"?-1:1);
        if(A>B) return (sortDir==="asc"? 1:-1);
        return 0;
      });

      tbody.innerHTML="";
      filtered.forEach(function(l){
        var tr=document.createElement("tr");
        tr.innerHTML =
          "<td>"+esc(l.name)+"</td>"+
          "<td>"+esc(l.email||"")+"</td>"+
          "<td>"+esc(l.phone||"")+"</td>"+
          "<td><span class='tag'>"+esc(l.stage||"novo")+"</span></td>"+
          "<td>"+esc(l.source||"")+"</td>"+
          "<td>"+esc(formatDate(l.date,l.createdAt))+"</td>"+
          "<td>"+new Date(l.createdAt).toLocaleString()+"</td>"+
          "<td>"+new Date(l.updatedAt).toLocaleString()+"</td>";
        var tdAct=document.createElement("td"); tdAct.className="actions-cell";
        var wa=document.createElement("a"); wa.href=formatPhoneToWa(l.phone); wa.target="_blank"; wa.rel="noreferrer"; wa.textContent="WhatsApp"; tdAct.appendChild(wa);
        var ed=document.createElement("button"); ed.textContent="Editar"; ed.onclick=function(){ editLead(l.id); }; tdAct.appendChild(ed);
        var dl=document.createElement("button"); dl.className="danger"; dl.textContent="Excluir"; dl.onclick=function(){ deleteLead(l.id); }; tdAct.appendChild(dl);
        tr.appendChild(tdAct);
        tbody.appendChild(tr);
      });
    }

    function persist(){ saveBlob(LS_KEY, JSON.stringify(leads)); }

    // ===== FORM =====
    form.addEventListener("submit", function(e){
      e.preventDefault();
      var lead={
        id: (window.crypto&&crypto.randomUUID)?crypto.randomUUID():String(Date.now()+Math.random()),
        name: form.name.value.trim(),
        email: form.email.value.trim(),
        phone: form.phone.value.trim(),
        stage: form.stage.value,
        source: form.source.value.trim(),
        notes: form.notes.value.trim(),
        date: form.date.value,
        createdAt: Date.now(),
        updatedAt: Date.now()
      };
      if(!lead.name){ alert("Informe ao menos o nome."); return; }
      leads.push(lead); persist(); form.reset(); render();
    });

    // ===== EDIT/DEL =====
    function editLead(id){
      var l=leads.find(function(x){return x.id===id;}); if(!l) return;
      var name=prompt("Nome:",l.name); if(name===null) return;
      var email=prompt("E-mail:",l.email||""); if(email===null) return;
      var phone=prompt("WhatsApp:",l.phone||""); if(phone===null) return;
      var stage=prompt("Est√°gio (novo, qualificado, proposta, ganho, perdido):",l.stage)||l.stage;
      var source=prompt("Origem:",l.source||""); if(source===null) return;
      var notes=prompt("Notas:",l.notes||""); if(notes===null) return;
      var date=prompt("Data (yyyy-mm-dd ou dd/mm/yyyy):",l.date||"")||l.date||"";
      Object.assign(l,{name,email,phone,stage,source,notes,date,updatedAt:Date.now()});
      persist(); render();
    }
    function deleteLead(id){
      if(!confirm("Excluir este lead?")) return;
      leads=leads.filter(function(x){return x.id!==id;});
      persist(); render();
    }

    // ===== SORT =====
    document.querySelectorAll("th[data-sort]").forEach(function(th){
      th.addEventListener("click", function(){
        var k=th.getAttribute("data-sort");
        if(sortKey===k) sortDir = (sortDir==="asc" ? "desc":"asc");
        else { sortKey=k; sortDir="asc"; }
        render();
      });
    });

    // ===== EXPORT/IMPORT =====
    if(exportBtn){
      exportBtn.addEventListener("click", function(){
        downloadFile("leads.csv", toCSV(leads), "text/csv;charset=utf-8");
      });
    }
    if(importInp){
      importInp.addEventListener("change", function(e){
        var f=e.target.files && e.target.files[0]; if(!f) return;
        var r=new FileReader();
        r.onload=function(){
          try{
            var arr=JSON.parse(r.result);
            if(Array.isArray(arr)){
              var by={}; leads.forEach(function(l){by[l.id]=l;});
              arr.forEach(function(n){ if(n&&n.id){by[n.id]=n;} });
              leads=Object.values(by); persist(); render();
              alert("Importado com sucesso!");
            }else alert("JSON inv√°lido (esperado array).");
          }catch(err){ alert("Falha ao ler JSON: "+err.message); }
        };
        r.readAsText(f);
      });
    }

    // ===== INIT =====
    ["input","change"].forEach(function(ev){
      search.addEventListener(ev,render);
      filterStage.addEventListener(ev,render);
      filterStart.addEventListener(ev,render);
      filterEnd.addEventListener(ev,render);
    });
    render();
  })();
  </script>
</body>
</html>
